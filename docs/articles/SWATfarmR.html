<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SWATfarmR">
<title>Getting started with SWATfarmR • SWATfarmR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting started with SWATfarmR">
<meta property="og:description" content="SWATfarmR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SWATfarmR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.7.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/SWATfarmR.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chrisschuerz/SWATfarmR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Getting started with SWATfarmR</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/chrisschuerz/SWATfarmR/blob/HEAD/vignettes/SWATfarmR.Rmd" class="external-link"><code>vignettes/SWATfarmR.Rmd</code></a></small>
      <div class="d-none name"><code>SWATfarmR.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="loading-swatfarmr">Loading <code>SWATfarmR</code><a class="anchor" aria-label="anchor" href="#loading-swatfarmr"></a>
</h2>
<p>You can install <code>SWATfarmR</code> from its GitHub repository. If
you did not install the <code>R</code> package yet, install it with
<code><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">remotes::install_github()</a></code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># If the package remotes is not installed run first:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'remotes'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">'chrisschuerz/SWATplusR'</span><span class="op">)</span></span></code></pre></div>
<p>Before we start exploring the package load
<code>SWATfarmR</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chrisschuerz/SWATfarmR" class="external-link">SWATfarmR</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="demo-data">Demo data<a class="anchor" aria-label="anchor" href="#demo-data"></a>
</h2>
<p>To work with <code>SWATfarmR</code> we need a SWAT model setup for
which we want to schedule farm management operations and a file in which
we define the management operation sequences and the rules on which we
base the operation scheduling. I will from now on refer to this file as
the management input file. <code>SWATdata</code> provides a set of fast
running, lightweight SWAT2012 and SWAT+ model setups of a head watershed
of the Little River Experimental Watershed (LREW; <span class="citation">Bosch et al. (<a href="#ref-Bosch2007" role="doc-biblioref">2007</a>)</span>). <code>SWATfarmR</code> comes
with a demo management input file which provides the operation templates
for the SWAT+ model setup that is available from
<code>SWATdata</code>.</p>
<p>Although the code below can also install <code>SWATdata</code> for
you, I recommend to install it before you start working with the example
below. To install <code>SWATdata</code> you can use again the
<code>remotes</code> package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">'chrisschuerz/SWATdata'</span><span class="op">)</span></span></code></pre></div>
<!--The [`SWATdata`](https://github.com/chrisschuerz/SWATdata#swatdata-) GitHub page gives an overview of the available data sets. -->
<div class="section level3">
<h3 id="loading-the-demo-data">Loading the demo data<a class="anchor" aria-label="anchor" href="#loading-the-demo-data"></a>
</h3>
<p>Demo data can be loaded with the function <code><a href="../reference/load_demo.html">load_demo()</a></code>.
With the input argument <code>dataset</code> you define which data you
want to load. To load a SWAT project simply define
<code>dataset = 'project'</code>. The <code>path</code> defines the path
on your local hard drive where you want to store the SWAT project
folder. <strong><em>Please try to avoid blanks in your path
names</em></strong> (e.g. ‘C:/this is a/path with blanks’).
<strong><em>This can cause issues when running the model. Try to use
e.g.</em></strong> ’_’ <strong><em>in your path names
instead.</em></strong> As the SWAT project is available as SWAT+ and as
SWAT2012 project you have to specify the <code>version</code> of the
SWAT project you want to load. At the moment there is only a demo for
SWAT+ available. So, use <code>version = 'plus'</code> to load a SWAT+
project
<!-- and `version = '2012'` to load a SWAT2012 version of the project -->.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The path where the SWAT demo project will be written</span></span>
<span><span class="va">demo_path</span> <span class="op">&lt;-</span> <span class="st">'Define:/your/path'</span></span>
<span></span>
<span><span class="co"># Loading a SWAT+ demo project</span></span>
<span><span class="va">proj_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_demo.html">load_demo</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">'project'</span>, </span>
<span>                       path <span class="op">=</span> <span class="va">demo_path</span>,</span>
<span>                       version <span class="op">=</span> <span class="st">'plus'</span><span class="op">)</span></span></code></pre></div>
<p>When you load a SWAT project <code><a href="../reference/load_demo.html">load_demo()</a></code> saves the
defined SWAT project in the file path that was defined with
<code>path = demo_path</code> and returns the final demo project path as
a character string in <code>R</code>. I assigned the output of
<code>load_demo</code> to the variable <code>proj_path</code> to use
this path later with <code>SWATfarmR</code>.</p>
<p>If you set <code>dataset = 'schedule'</code> you can load the demo
management input file for the SWAT+ demo project. Again use
<code>path = demo_path</code> to define the path where the <em>csv</em>
file is written. Although there is only a demo management input file
available for SWAT+ available at the moment you have to define
<code>version = 'plus'</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Loading a SWAT+ demo project</span></span>
<span><span class="va">mgt_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_demo.html">load_demo</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">'schedule'</span>, </span>
<span>                      path <span class="op">=</span> <span class="va">demo_path</span>,</span>
<span>                      version <span class="op">=</span> <span class="st">'plus'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Warning in load_demo(dataset = "project", path = demo_path, version = "+"): Demo</span></span>
<span><span class="co">#&gt; already exists in provided 'path'. To work with the existing demo project use</span></span>
<span><span class="co">#&gt; the returned path.</span></span></code></pre>
<p>Again <code><a href="../reference/load_demo.html">load_demo()</a></code> returns the path of the <em>csv</em>
file as a character string in <code>R</code> which will be useful in our
<code>SWATfarmR</code> workflow. I assigned the file path to the
variable <code>mgt_path</code>. The management input file is key to
control the management scheduling with <code>SWATfarmR</code>. Setting
up this file requires to keep a very clear file structure. For the rules
which control the management scheduling you can make use of several
variables which eventually affect the operation dates that will be set
in the management schedules. So it is worth to have a detailed look into
this file.</p>
</div>
</div>
<div class="section level2">
<h2 id="the-management-input-file">The management input file<a class="anchor" aria-label="anchor" href="#the-management-input-file"></a>
</h2>
<p>The <code>SWATfarmR</code> workflow reads the management operations
from a <em>csv</em> file. Depending how complex you define the
management to be for a SWAT model setup this file can be rather long.
The <em>csv</em> file can be edited and prepared in any spreadsheet
software, such as Excel or Libre office Calc which may be easier than
processing the file in <code>R</code>.</p>
<p>The image below shows a minimum example for a management input file
for a SWAT+ model setup. The columns <strong>land_use</strong>,
<strong>management</strong>, <strong>weight</strong>,
<strong>filter_unit</strong>, and <strong>condition_schedule</strong>
are the same for SWAT2012 and SWAT+ and are required in the table even
if they are left empty. The remaining columns are SWAT version dependent
and are the actual operation parameters which are written into the
management schedules of the SWAT model input files. SWAT+ management
operations consist of the <strong>operation</strong> type and three
parameters for each operation which are called
<strong>op_data1</strong>, <strong>op_data2</strong>, and
<strong>op_data3</strong>. These names are used as column names in the
management input file. SWAT2012 management inputs also use different
<strong>operation</strong> types, but each operation can be controlled
by 9 different parameters <strong>mgt1</strong> to
<strong>mgt9</strong>. Thus the <code>SWATfarmR</code> management input
must be prepared for SWAT2012 model setups accordingly. The following
explanations only address the use of <code>SWATfarmR</code> with SWAT+
model setups. An application with SWAT2012 may be added in the
future.</p>
<div class="figure">
<img src="figures/mgt_tbl_ex.JPG" alt=""><p class="caption">Fig. 1: Minimum example of a management input file.
The table shows only operations for one <strong>land_use</strong> and
one crop. In the example no <strong>management</strong> alternatives and
<strong>filter_attributes</strong> would be applied.</p>
</div>
<p>In the <strong>land_use</strong> column all operations that belong to
one land use are grouped together. In the small example above all 5
operations should be scheduled for the land use <em>‘lu1_lum’</em>. All
land uses which are defined in <strong>land_use</strong> must be defined
in the file <em>‘landuse.lum’</em> and must be assigned to HRUs in
<em>‘hru-data.hru’</em>. Otherwise this management will not be
implemented in the model setup.</p>
<p>The columns <strong>management</strong> and <strong>weight</strong>
are always used together. These provide the option to randomly
distribute different managements in a model setup. A SWAT modeler can
have for example statistical data on the implementation of conservation
farming, but no data is available on the actual locations of
implementation. Then <strong>management</strong> and
<strong>weight</strong> allow a random distribution of e.g. different
tillage types in the catchment based on weighted random sampling using
the provided <strong>weight</strong>s. Providing information in these
columns is optional. Thus in most cases <strong>management</strong> and
<strong>weight</strong> are left empty.</p>
<p>With <strong>filter_unit</strong> the user has the option to apply
operations only to HRUs which fulfill certain criteria which are defined
here. These criteria can for example be a slope threshold, soil type or
location (in defined routing units). Below this will be further
explained. Providing such criteria is optional and in most cases
<strong>filter_unit</strong> is left empty.</p>
<p>The most important column is <strong>condition_schedule</strong> in
which you define the temporal conditions for scheduling an operation.
The conditions which can be defined here are very flexible and endless
combinations are possible to control the operation scheduling. This
flexibility is however also a potential source for error. Thus the
definition of scheduling conditions will be covered in great detail
below.</p>
<p><strong>operation</strong> and the corresponding parameters
<strong>op_data</strong> 1 to 3 define the actual SWAT management. All
management operations and parameters which are defined here must be
defined in the SWAT model setup to work. If for example a fertilizer
application is defined then <strong>op_data1</strong> defines the
fertilizer type. In the example above <em>‘elem_n’</em> is applied. This
fertilizer type must then be defined in the SWAT+ input file
<em>‘fertilizer.frt’</em>.</p>
<div class="figure">
<img src="figures/filter_workflow.svg" alt=""><p class="caption">Fig. 2: Schematic workflow of filtering operation
schedules based on <strong>land_use</strong>,
<strong>management</strong>, and <strong>filter_attribute</strong></p>
</div>
<div class="section level3">
<h3 id="land_use">land_use<a class="anchor" aria-label="anchor" href="#land_use"></a>
</h3>
<p>The <strong>land_use</strong> label defines to which land use class
the sequences of operations that are defined in the table belong to.
When the scheduling routine of <code>SWATfarmR</code> iterates over all
HRUs, the routine filters all operations from the management input table
where the land uses in the column <strong>land_use</strong> match the
HRUs land use (which is defined in the file <em>‘hru-data.hru’</em>. See
the figure above.). This means that you must be careful how you define
the land uses in the management input table. Not match land use labels
are ignored in the scheduling (e.g. in the case of typos). If you
accidentally put an operation sequence for a land use into the table
twice all these data will be used in the operation scheduling (so be
careful when copy pasting!).</p>
</div>
<div class="section level3">
<h3 id="management-and-weight">management and weight<a class="anchor" aria-label="anchor" href="#management-and-weight"></a>
</h3>
<p>With <strong>management</strong> and <strong>weight</strong> you can
introduce different management types that you want to apply to HRUs with
weighted random sampling. This is useful when you want to translate
statistical information into the farm management in a SWAT model
setup.</p>
<div class="figure">
<img src="figures/mgt_wgt_tbl.JPG" alt=""><p class="caption">Fig. 3: Filtering operations based on different
<strong>management</strong> alternatives.</p>
</div>
<p>Let us assume that in the example above we know from agricultural
statistics that for the <strong>land_use</strong> <em>‘lu1_lum’</em>
(which was selected for the current HRU) 40% of the farmers do
conventional farming and 60% do organic farming. For the different
practices we want to implement different tillage types and fertilizer
types and amounts. In the management input file we introduce two
different managements for all tillage and fertilizer operations. You can
select any names for the two different managements. You just have to be
consistent with the names for all operations that you want to introduce
as alternatives. The percentages of the two farm practices we add as
weights for the respective operations. The tillage alternatives only
differ in the selected plough type. For the fertilizer operations you
can see that <em>‘conventional’</em> uses two fertilizer operations
while <em>‘organic’</em> does one manure application. For all other
operations that should be used in both managements just keep the
management and the weight columns empty. In the example table you can
see that the <em>‘conventional’</em> alternative was selected for the
current HRU. The white rows in the table will be removed from the
operation scheduling of this HRU.</p>
</div>
<div class="section level3">
<h3 id="filter_attribute">filter_attribute<a class="anchor" aria-label="anchor" href="#filter_attribute"></a>
</h3>
<p>There are cases where we want to use the same management practice
sequences (e.g. the same crop rotation) for different HRUs, but we want
to introduce some different operations because of some any HRU
attributes. You might want to use different tillage practices for
different soils, or want to apply contour farming on steeper slopes, or
you for example know that the amounts of fertilizer differ between
regions (which may correspond to routing units or subbasins in your
model setup). Similar to the different managements above you can also
select the operation that should be scheduled for an HRU, based on the
HRUs attributes. Below you can see the <code>hru_attributes</code> table
of a <code>SWATfarmR</code> project. It shows all attributes that
implemented to select operations at the moment.</p>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 49 × 9</span></span></span>
<span><span class="co">#&gt;      rtu rtu_name   hru hru_name lu_mgt    soil      slp slp_len hyd_grp</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 rtu10        1 hru01    agrl4_lum LREW06 0.030<span style="text-decoration: underline;">9</span>      60 B      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1 rtu10        2 hru02    agrl1_lum LREW06 0.032<span style="text-decoration: underline;">7</span>      60 B      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1 rtu10        3 hru03    agrl1_lum LREW10 0.028<span style="text-decoration: underline;">2</span>      90 D      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1 rtu10        4 hru04    agrl1_lum LREW09 0.021<span style="text-decoration: underline;">5</span>      90 C      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1 rtu10        5 hru05    frse_lum  LREW06 0.043<span style="text-decoration: underline;">2</span>      60 B      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1 rtu10        6 hru06    frse_lum  LREW03 0.038<span style="text-decoration: underline;">6</span>      60 B      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1 rtu10        7 hru07    frse_lum  LREW10 0.032<span style="text-decoration: underline;">1</span>      60 D      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1 rtu10        8 hru08    frse_lum  LREW05 0.046<span style="text-decoration: underline;">0</span>      60 B      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1 rtu10        9 hru09    frse_lum  LREW08 0.058<span style="text-decoration: underline;">2</span>      30 C      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     1 rtu10       10 hru10    agrl2_lum LREW03 0.036<span style="text-decoration: underline;">3</span>      60 B      </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 39 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ Use `print(n = ...)` to see more rows</span></span></span></code></pre>
<p>The attributes that can be useful in practice are <code>rtu</code>,
<code>soil</code>, <code>slp</code>, <code>slp_len</code>, and
<code>hyd_grp</code>. You can use and combine filter conditions for
these attributes in many different ways. You should however clearly
consider the consequences for the operation scheduling when you filter
operations based on HRU attributes. In the schematic workflow in Fig. 2
you can for example see that I introduced 2 conditions which complement
each other. By conditioning one operation with
<code>slp &gt;= 0.08</code> and a second one with
<code>slp &lt; 0.8</code> one of the two operations will be used and
there will not be a case where none or both operations are kept in the
operation schedule. Below I show a few small examples for conditions to
filter based on HRU attributes.</p>
<p>If you want to use a specific operation for example only in the
management schedules of the routing units 1 to 5, 7, and 10 you could
for example use the following condition:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rtu</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">7</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>If you add this condition for one operation but you do not provide an
alternative all other routing units will not use an alternative to this
operation. To provide an alternative for all other locations you can for
example use the following condition for the alternative operation:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">!</span> <span class="va">rtu</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">7</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>To apply an operation only for the soil <em>‘LREW06’</em> you can use
the following:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soil</span> <span class="op">==</span> <span class="st">'LREW06'</span></span></code></pre></div>
<p>The alternative again would be:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soil</span> <span class="op">!=</span> <span class="st">'LREW06'</span></span></code></pre></div>
<p>If you want to consider several soils, this is the way to do it:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soil</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'LREW06'</span>, <span class="st">'LREW09'</span><span class="op">)</span></span></code></pre></div>
<p>You can also combine conditions:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soil</span> <span class="op">!=</span> <span class="st">'LREW06'</span> <span class="op">&amp;</span> <span class="va">rtu</span>  <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">7</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">slp</span> <span class="op">&lt;=</span> <span class="fl">0.08</span></span></code></pre></div>
<p>This operation would be implemented for all HRUs with a soil type
that is not <em>‘LREW06’</em> for the routing units 1 to 5, 7, and 10
and only on slopes lower equal to 0.08.</p>
</div>
<div class="section level3">
<h3 id="condition_schedule">condition_schedule<a class="anchor" aria-label="anchor" href="#condition_schedule"></a>
</h3>
<p><strong>condition_schedule</strong> controls the temporal scheduling
of the management operations. The condition definition works in similar
to the attribute filtering with <strong>filter_attribute</strong>. The
main difference is that <strong>filter_attribute</strong> requires
either <code>TRUE</code> or <code>FALSE</code> as a result from the
filter condition to decide whether an operation is scheduled for an HRU
or not. <strong>condition_schedule</strong>, however, allows to assign
probabilities to dates based on the defined conditions to control “how
likely” it is that an operation takes place on a certain day. Similar to
<strong>filter_attribute</strong> there are a few default variables that
the user can use to define scheduling conditions. The table below
summarizes them.</p>
<table class="table">
<colgroup>
<col width="16%">
<col width="61%">
<col width="22%">
</colgroup>
<thead><tr class="header">
<th>Variable</th>
<th>Definition</th>
<th>Usage</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>prev_op</code></td>
<td>Date of the previous operation in <code>&lt;date&gt;</code>
format.</td>
<td>2000-01-01</td>
</tr>
<tr class="even">
<td><code>date</code></td>
<td>Date of the actual operation in <code>&lt;date&gt;</code>
format.</td>
<td>2000-01-01</td>
</tr>
<tr class="odd">
<td><code>year</code></td>
<td>Year of a date in a 4 digit integer format.</td>
<td>2000</td>
</tr>
<tr class="even">
<td><code>month</code></td>
<td>Month of a date as integer value.</td>
<td>Numbers 1 to 12</td>
</tr>
<tr class="odd">
<td><code>day</code></td>
<td>Day of a date as integer value.</td>
<td>Numbers 1 to 31</td>
</tr>
<tr class="even">
<td><code>jdn</code></td>
<td>Julian of a date as integer value.</td>
<td>Numbers 1 to 366</td>
</tr>
<tr class="odd">
<td><code>md</code></td>
<td>Month and day of a date as a combined integer value.</td>
<td>e.g. 101 (Jan. 1), 1125 (Nov. 25)</td>
</tr>
<tr class="even">
<td><code>ymd</code></td>
<td>Month and day and year of a date as a combined integer value.</td>
<td>e.g. 20000101 (Jan. 1 2000)</td>
</tr>
<tr class="odd">
<td><code>pcp</code></td>
<td>Daily precipitation sum for a certain date in mm.</td>
<td>1.23</td>
</tr>
<tr class="even">
<td><code>tmax</code></td>
<td>Maximum daily temperature for a certain date in mm.</td>
<td>1.23</td>
</tr>
<tr class="odd">
<td><code>tmin</code></td>
<td>Minimum daily temperature for a certain date in mm.</td>
<td>1.23</td>
</tr>
<tr class="even">
<td><code>tav</code></td>
<td>Average daily temperature for a certain date in mm.</td>
<td>1.23</td>
</tr>
<tr class="odd">
<td><code>hu_&lt;crop&gt;</code></td>
<td>
<em>SWAT+ specific.</em> Heat units of a crop at a certain date
after planting and before harvesting that crop. Replace <crop> with the
crop that was planted.</crop>
</td>
<td>hu_wwht for winter wheat</td>
</tr>
<tr class="even">
<td><code>grw_&lt;crop&gt;</code></td>
<td>
<em>SWAT+ specific.</em> Days a crop is already growing after
planting that crop. Replace <crop> with the crop that was planted.</crop>
</td>
<td>grw_wwht for winter wheat</td>
</tr>
<tr class="odd">
<td><code>hu</code></td>
<td>
<em>SWAT2012 specific.</em> Heat units of a crop at a certain date
after planting and before harvesting that crop. No <crop> handle needed
as only one crop can grow on an HRU at the same time.</crop>
</td>
<td></td>
</tr>
<tr class="even">
<td><code>hu_fr</code></td>
<td>
<em>SWAT2012 specific.</em> Heat unit fraction of a crop at a
certain date after planting and before harvesting that crop. No <crop>
handle needed as only one crop can grow on an HRU at the same time. The
fraction is calculated based on <code>hu</code> and the heat units that
were defined for a crop when planting.</crop>
</td>
<td></td>
</tr>
</tbody>
</table>
<p>Fig. 4 again shows the management input from the previous examples
after selecting all rows where <strong>land_use</strong> is
<em>‘lu1_lum’</em> and after selecting the <em>‘conventional’</em>
<strong>management</strong> and filtering the operations by specific HRU
attributes. You can immediately see two things in the column
<strong>condition_schedule</strong>. The conditions do have a similar
structure as the conditions for <strong>filter_attribute</strong> and
that there are operations where <strong>condition_schedule</strong> is
left empty.</p>
<p>An empty <strong>condition_schedule</strong> can have two
functions:</p>
<ol style="list-style-type: decimal">
<li>The operation <code>initial_plant</code> does not use any conditions
to set the operation. <code>skip</code> can be triggered with conditions
but does not necessarily need one.</li>
<li>For other operations (e.g. <code>fertilizer</code> application of
<code>elem_p</code> in Fig.4) leaving
<strong>condition_schedule</strong> empty results in scheduling this
operation at the same date as the previous operation.</li>
</ol>
<div class="figure">
<img src="figures/mgt_schdl_tbl.JPG" alt=""><p class="caption">Fig. 4: Example for operation schedule with temporal
conditions.</p>
</div>
<p>All conditions that were implemented to control the scheduling of the
operations in the example in Fig. 4 follow almost the same pattern. The
condition for the <code>plant</code> operation for example is the
following:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">md</span> <span class="op">&gt;=</span> <span class="fl">0427</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">md</span> <span class="op">&lt;=</span> <span class="fl">0507</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="../reference/w_log.html">w_log</a></span><span class="op">(</span><span class="va">pcp</span>, <span class="fl">0</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fu">year</span><span class="op">(</span><span class="va">prev_op</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>You can see that it uses the variables <code>md</code>,
<code>pcp</code>, <code>year</code>, and <code>prev_op</code> that are
listed in the table above. Further the condition uses the two functions
<code><a href="../reference/w_log.html">w_log()</a></code> and <code>year()</code>. <code>year()</code> is
available from the <code>R</code> package <code>lubridate</code> and
returns the year of a date as an integer value. <code><a href="../reference/w_log.html">w_log()</a></code> on
the other hand is a function that was included in
<code>SWATfarmR</code>. The function implements a logistic function to
calculate weights with a smooth transition between an upper and lower
value. Besides <code><a href="../reference/w_log.html">w_log()</a></code> there is also <code><a href="../reference/w_lin.html">w_lin()</a></code>
which does a linear transition between the upper and the lower value.
Below you can see how the two functions look like. A major difference
between the two functions is that <code><a href="../reference/w_log.html">w_log()</a></code> converges to 0
and 1 at its boundaries, but does not reach these values, while
<code><a href="../reference/w_lin.html">w_lin()</a></code> reaches 0 and 1 at its boundaries. Overall I always
prefer to use <code><a href="../reference/w_log.html">w_log()</a></code> in the condition definition as it is
safer to not risk of having all probabilities for an operation 0 but
very low and thus risking to skip the scheduling of an operation. This
can however happen more easily with <code><a href="../reference/w_lin.html">w_lin()</a></code> resulting in
0.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>,<span class="fl">1.5</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">log_wgt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/w_log.html">w_log</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">lin_wgt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/w_lin.html">w_lin</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">log_wgt</span>, type <span class="op">=</span> <span class="st">'l'</span>, col <span class="op">=</span> <span class="fl">2</span>, ylab <span class="op">=</span> <span class="st">'weight'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">lin_wgt</span>, col <span class="op">=</span> <span class="fl">4</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"w_log"</span>, <span class="st">"w_lin"</span><span class="op">)</span>,</span>
<span>       col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, cex<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="SWATfarmR_files/figure-html/unnamed-chunk-16-1.png" alt="Fig. 5: Functional relationship of a variable with the two weight functions w_log() and w_lin()." width="700"><p class="caption">
Fig. 5: Functional relationship of a variable with the two weight
functions w_log() and w_lin().
</p>
</div>
<p>We will now go through the individual conditions that were combined
by multiplying them. The first two conditions use <code>md</code>. In
the first expression <code>md &gt;= 0427</code>, which means the
combination of month and day must be larger or equal to 427. This
translates to a date in any year later or equal than April 27. The
second expression translates to all dates in any year earlier or equal
to May 7. When we multiply those two expressions all dates between April
27 and May 7 get a probability of 1 while all dates outside of this time
window do have a probability of 0.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">md</span> <span class="op">&gt;=</span> <span class="fl">0427</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">md</span> <span class="op">&lt;=</span> <span class="fl">0507</span><span class="op">)</span></span></code></pre></div>
<p>The third expression uses the <code><a href="../reference/w_log.html">w_log()</a></code> function together
with precipitation. The second and third input argument in the function
define the lower and upper boundary values of the transition range. In
this case <code><a href="../reference/w_log.html">w_log()</a></code> returns the value 0.01 when
<code>pcp = 2</code> and a value 0.99 when <code>pcp = 10</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="../reference/w_log.html">w_log</a></span><span class="op">(</span><span class="va">pcp</span>, <span class="fl">0</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Plotting the function shows the intention of this condition. We
assign to all daily precipitation sums lower of 0 mm a weight of
(almost) 1. Yet, precipitation sums of 2 mm still have a probability of
0.88 and at 4 mm 0.34. Daily precipitation sums of larger than 7 mm
receive a weight of (almost) 0. This condition makes the scheduling of
operations on days that exceed a certain precipitation less likely.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">8</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">weight</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="../reference/w_log.html">w_log</a></span><span class="op">(</span><span class="va">pcp</span>, <span class="fl">0</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pcp</span>, <span class="va">weight</span>, type <span class="op">=</span> <span class="st">'l'</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="SWATfarmR_files/figure-html/unnamed-chunk-19-1.png" alt="Fig. 6: Example for using w_log() to assign lower weights to days with higher precipitation." width="700"><p class="caption">
Fig. 6: Example for using w_log() to assign lower weights to days with
higher precipitation.
</p>
</div>
<p>We can now combine all 3 conditions and use this combination for
scheduling the <code>plant</code> operation. When we compare the time
series of precipitation and the weights based on precipitation we can
see that all days without precipitation get a weight of 1 while rainy
days will have a weight lower than one. The red bars show the combined
weights for all days. You can see that the conditions with
<code>md</code> define the time window between April 27 and May 7. In
this time window dates are then excluded or have a lower weight
depending on the precipitation on these dates. The operation scheduling
algorithm selects a date for an operation with weighted random sampling.
Thus all dates with a weight &gt; 0 can be selected. Dates with larger
weights are however more likely to be selected than dates with smaller
weights.</p>
<div class="figure">
<img src="SWATfarmR_files/figure-html/unnamed-chunk-20-1.png" alt="Fig. 5: Combination of 3 conditions to a combined condition for scheduling an operation." width="960"><p class="caption">
Fig. 5: Combination of 3 conditions to a combined condition for
scheduling an operation.
</p>
</div>
<p>The fourth element of the entire scheduling condition refers to the
year. This is necessary because the <code>md</code> conditions only
constrain the time window by month and day. This time window is however
given in the current year of scheduling, but also in all future years.
Thus, there is a risk that the scheduling of an operation skips years.
To avoid the skipping of years I strongly recommend to add a constrain
that the current operation must be scheduled in the same year as the
previous operation.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fu">year</span><span class="op">(</span><span class="va">prev_op</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This constrain does however not apply to the first operation or the
first operation of any year in a crop rotation. In this case you can,
however, define that this operation should take place in the year that
is the year of the previous operation plus 1.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fu">year</span><span class="op">(</span><span class="va">prev_op</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="operation-and-op_data">operation and op_data<a class="anchor" aria-label="anchor" href="#operation-and-op_data"></a>
</h3>
<p>The columns <strong>operation</strong>, <strong>op_data1</strong>,
<strong>op_data2</strong>, and <strong>op_data3</strong> are eventually
written into the <em>’management.sch</em>’ input file of the SWAT+ model
setup. Different operations require different <strong>op_data</strong>
parameters. Please refer to the SWAT+ documentation to learn how to
define the parameters for the management operations.</p>
<p>A selection of <strong>operation</strong>s are available in SWAT
which you can trigger in a SWAT simulation. The table below lists the
<code>SWATfarmR</code> labels and their corresponding SWAT+ labels.</p>
<table class="table">
<colgroup>
<col width="25%">
<col width="25%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>
<code>SWATfarmR</code> code</th>
<th>SWAT+ code</th>
<th>Definition</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>plant</td>
<td>plnt</td>
<td>Planting operation</td>
</tr>
<tr class="even">
<td>irrigation</td>
<td>irrm</td>
<td>Irrigation operation</td>
</tr>
<tr class="odd">
<td>fertilizer</td>
<td>fert</td>
<td>Fertilizer application</td>
</tr>
<tr class="even">
<td>pesticide</td>
<td>pest</td>
<td>Pesticide application</td>
</tr>
<tr class="odd">
<td>harvest_kill</td>
<td>hvkl</td>
<td>Harvest and kill the plant</td>
</tr>
<tr class="even">
<td>tillage</td>
<td>till</td>
<td>Tillage operation</td>
</tr>
<tr class="odd">
<td>harvest_only</td>
<td>harv</td>
<td>Only harvest the plant (or a part of the plant)</td>
</tr>
<tr class="even">
<td>kill_only</td>
<td>kill</td>
<td>Kill the plant</td>
</tr>
<tr class="odd">
<td>grazing</td>
<td>graz</td>
<td>Grazing operation</td>
</tr>
<tr class="even">
<td>street_sweeping</td>
<td>swep</td>
<td>Sweeping operation</td>
</tr>
<tr class="odd">
<td>burn</td>
<td>burn</td>
<td>Burning operation</td>
</tr>
<tr class="even">
<td>skip</td>
<td>skip</td>
<td>Skip a year</td>
</tr>
<tr class="odd">
<td>initial_plant</td>
<td>inip</td>
<td>Define the initial crop</td>
</tr>
</tbody>
</table>
<p>The only non-SWAT specific operation in the table above is
<code>initial_plant</code>. This is a required input for every
<strong>land_use</strong> that is defined in the management input file.
The <code>initial_plant</code> must refer to a plant community that is
defined in the <em>‘plant.ini’</em> SWAT+ input file.</p>
</div>
</div>
<div class="section level2">
<h2 id="a-new-swatfarmr-project-in-r">A new <code>SWATfarmR</code> project in <code>R</code><a class="anchor" aria-label="anchor" href="#a-new-swatfarmr-project-in-r"></a>
</h2>
<p><code>SWATfarmR</code> uses an object based approach to work with
your SWAT project. This means that when you start a new
<code>SWATfarmR</code> project an object (I will call it
<code>farmr</code> project or <code>farmr</code> object, if I refer to
the <code>R</code> object, from now on) will be generated in your
<code>R</code> environment. The <code>farmr</code> project stores
relevant data of your SWAT project, such as the weather data or HRU
attributes and provides functions to work with theses data and
eventually allows you to schedule management operation for your SWAT
project. In this small example we will use the demo data that I
described in the section <a href="https://chrisschuerz.github.io/SWATfarmR/articles/SWATfarmR.html#demo-data">Demo
data</a> above. If you did not load the demo project and the demo
management input file yet, please do that before you continue. To start
a new <code>farmr</code> project use the function
<code><a href="../reference/new_farmr.html">new_farmr()</a></code>. The function requires two inputs. First you
have to name your project. This will be the name of your
<code>farmr</code> project in <code>R</code> and the name of the
<em>‘.farm’</em> file in your SWAT project folder. If you want to
generate several <code>farmr</code> projects for a SWAT project, they
have to have different names. The function also requires the path of
your SWAT project on the hard drive as an input argument. In this
example I will call the <code>farmr</code> project
<code>lrew_demo</code> and will use the path of the demo SWAT project
<code>proj_path</code> which we already defined in the section <a href="https://chrisschuerz.github.io/SWATfarmR/articles/SWATfarmR.html#demo-data">Demo
data</a>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/new_farmr.html">new_farmr</a></span><span class="op">(</span>project_name <span class="op">=</span><span class="st">'lrew_demo'</span>, </span>
<span>          project_path <span class="op">=</span> <span class="va">proj_path</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt;  Finished in 1S  </span></span></code></pre></div>
<p>Now have a look in to your <code>R</code> variables. There is now a
new object called <code>lrew_demo</code> which is our <code>farmr</code>
project. You will also find the file <em>‘lrew_demo.farm’</em> in your
SWAT project folder. This is the file where all your work with in your
<code>farmr</code> project will be saved and from which you can load
your <code>farmr</code> project to continue with your work.</p>
<div class="section level3">
<h3 id="a-quick-look-into-the-farmr-object">A quick look into the <code>farmr</code> object<a class="anchor" aria-label="anchor" href="#a-quick-look-into-the-farmr-object"></a>
</h3>
<p>You can now start exploring the generated <code>farmr</code> object
in <code>R</code>. To see all elements that are in the new project you
can use the <code>$</code> operator, like you would access elements of a
list in <code>R</code>. Fig. 6 shows a screenshot of the new
<code>farmr</code> object and the suggestions to select an element after
entering the <code>$</code> operator. The first 4 elements are functions
to apply operations to your <code>farmr</code> project. The last element
<code>.$.data</code> holds the data that was read from the SWAT project,
such as the weather inputs <em>‘pcp’</em> and <em>‘tmp’</em> or HRU
attributes.</p>
<p>From the 4 functions, only <code>.$add_variable()</code> and
<code>.$read_management()</code> are relevant to you as a user.
<code>.$initialize()</code> is synonymous to <code><a href="../reference/new_farmr.html">new_farmr()</a></code>
which we already performed. With <code>.$save()</code> you can save the
current state of the <code>farmr</code> project at any time. Saving is
however done after each operation automatically. Thus, manually saving
should not be necessary. After executing some of the functions and
working through the operation scheduling, new functions will be
activated (e.g. after reading the management input with
<code>.$read_management()</code> the function
<code>.$schedule_operations()</code> becomes visible).</p>
<div class="figure">
<img src="figures/farmr_screenshot.JPG" alt=""><p class="caption">Fig. 6: Screenshot of the new <code>farmr</code>
object in <code>R</code>.</p>
</div>
</div>
<div class="section level3">
<h3 id="reading-the-management-input">Reading the management input<a class="anchor" aria-label="anchor" href="#reading-the-management-input"></a>
</h3>
<p>We will now read the management input file for the demo project which
we saved on the hard drive in the path <code>mgt_path</code> into the
<code>farmr</code> project. This is done with the function
<code>.$read_management()</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrew_demo</span><span class="op">$</span><span class="fu">read_management</span><span class="op">(</span>file <span class="op">=</span> <span class="va">mgt_path</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; Warning: No management schedules were found for the following SWAT land uses: </span></span>
<span><span class="co">#&gt;   utrn_lum, urml_lum</span></span>
<span><span class="co">#&gt;   If managements should be written for any of these land uses</span></span>
<span><span class="co">#&gt;   please add them to the management table and read the table again.</span></span></code></pre></div>
<p>You can see that loading the management input file triggers a warning
message. The management input file does not define any management for
the land uses <em>‘utrn_lum’</em> and <em>‘urml_lum’</em>. In this case
this is OK and we can ignore the warning message as we do not want to
apply any management to the urban land uses. If the warning message
however lists land uses of your model setup for which you intend to
implement a management you should go back to your management input file,
include the managements for the missing land uses and load it again with
<code>.$read_management()</code>. Besides the input argument
<code>file</code>, <code>.$read_management()</code> also has a second
input argument <code>discard_schedule</code>. You can ignore this when
reading a management into a new <code>farmr</code> project. You have to
set this however <code>discard_schedule = TRUE</code> if you already
scheduled operations with an other management input file, but you want
to change the management inputs. Then the already scheduled operations
would not match the new management input file that you plan to read. In
this case you would have to discard the already scheduled
operations.</p>
<p>Reading the management input into our <code>farmr</code> project
<code>lrew_demo</code> unlock the function
<code>.$schedule_operations()</code>. With
<code>.$schedule_operations()</code> we can schedule management
operations based on the operations and conditions that we defined in the
management input file. We can just try to run the operation scheduling
and see what happens.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrew_demo</span><span class="op">$</span><span class="fu">schedule_operations</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; Scheduling operations:</span></span>
<span><span class="co">#&gt; Error in `mutate()`:</span></span>
<span><span class="co">#&gt; ! Problem while computing `wgt = ... * (year == (year(prev_op) + 1))`.</span></span>
<span><span class="co">#&gt; Caused by error in `w_log()`:</span></span>
<span><span class="co">#&gt; ! object 'api' not found</span></span>
<span><span class="co">#&gt; Backtrace:</span></span>
<span><span class="co">#&gt;   1. lrew_demo$schedule_operations()</span></span>
<span><span class="co">#&gt;  10. SWATfarmR::w_log(api, 5, 20)</span></span></code></pre></div>
<p>Scheduling operations triggered an error. A closer look into the
error message tells us that <code>object 'api' not found</code> and that
the error occurred in <code>SWATfarmR::w_log(api, 5, 20)</code>. This
looks like one of the operation conditions in the management input file.
If you have a look into the demo management input file you can see that
I actually included the variable <code>api</code> into the scheduling
conditions with the function <code>(1 - w_log(api, 5, 20))</code>. The
variable <code>api</code> is however no default variable (see again the
table in the subsection <a href="https://chrisschuerz.github.io/SWATfarmR/articles/SWATfarmR.html#condition_schedule">condition_schedule</a>)
and we have to add this variable to the <code>farmr</code> project if we
want to use it in the scheduling conditions.</p>
</div>
<div class="section level3">
<h3 id="adding-variables">Adding variables<a class="anchor" aria-label="anchor" href="#adding-variables"></a>
</h3>
<p>My intention with the <code>api</code> condition was to include the
antecedent precipitation (api = antecedent precipitation index) as a
condition for the operation scheduling. A disadvantage of
<code>SWATfarmR</code> compared to decision tables in SWAT+ is that the
operation scheduling with <code>SWATfarmR</code> cannot make use of the
values of any state variables during the simulation which is possible
with decision tables. While for example decision tables can use the soil
moisture as a condition, <code>SWATfarmR</code> must use a proxy
variable which is related to the “wetness” of the soil.</p>
<div class="section level4">
<h4 id="excursus-variable_decay">Excursus <code>variable_decay()</code><a class="anchor" aria-label="anchor" href="#excursus-variable_decay"></a>
</h4>
<p>One approach to account for the precipitation of previous days would
be to calculate the precipitation sums for a certain number of days
before the current day. This might however not be the best approach to
do that. As an alternative approach, I included a function called
<code><a href="../reference/variable_decay.html">variable_decay()</a></code> in <code>SWATfarmR</code> which assigns
weights to previous days based on exponential decay. The example below
shows how the weight of an event on day 1 changes for following days.
Depending on the <code>decay_rate</code> the weight of day 1 would only
have a weight of 0.37 for a <code>decay_rate = 1</code>, but still be
accounted with 0.78 with a <code>decay_rate = 0.25</code>. The event on
day 1 would not have much impact from day 5 on for
<code>decay_rate = 1</code>, but would still have a weight of 0.37 for
<code>decay_rate = 0.25</code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y1</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_decay.html">variable_decay</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">x</span>, n_steps <span class="op">=</span> <span class="op">-</span><span class="fl">10</span>, decay_rate <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">y2</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_decay.html">variable_decay</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">x</span>, n_steps <span class="op">=</span> <span class="op">-</span><span class="fl">10</span>, decay_rate <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">y3</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_decay.html">variable_decay</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">x</span>, n_steps <span class="op">=</span> <span class="op">-</span><span class="fl">10</span>, decay_rate <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">y1</span><span class="op">$</span><span class="va">x_1</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="fl">1</span>, ylab <span class="op">=</span> <span class="st">'weight'</span>, xlab <span class="op">=</span> <span class="st">'day'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">y2</span><span class="op">$</span><span class="va">x_1</span>, col <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">y3</span><span class="op">$</span><span class="va">x_1</span>, col <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="SWATfarmR_files/figure-html/unnamed-chunk-26-1.png" alt="Fig. 7: The effect of `decay_rate` on the `variable_decay()` function." width="700"><p class="caption">
Fig. 7: The effect of <code>decay_rate</code> on the
<code><a href="../reference/variable_decay.html">variable_decay()</a></code> function.
</p>
</div>
<p>The small example below should illustrate how we can use
<code><a href="../reference/variable_decay.html">variable_decay()</a></code> to account for antecedent precipitation.
The black bars in the plot are daily precipitation sums. I calculated
<code><a href="../reference/variable_decay.html">variable_decay()</a></code> including the 5 previous days
(<code>time_steps &lt;- -5</code>) and used the two rates 0.25 (black
line) and 1 (red line). If we would condition <code>api</code> now with
the rule that triggered the error above
(<code>(1 - w_log(api, 5, 20))</code>) we would get lower probabilities
for the days after the large precipitation event on day 4 for both api
time series. While the red line would be already below 5 mm on day 6,
the black line does not fall below 11.5 mm. Thus, in the case of the
black line several days after a rain event would have lower weights in
the operation scheduling. The behaviors of the two api lines could
e.g. be translated to different water retention behaviors of different
soils.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pcp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>pcp_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span>,<span class="fl">7</span>,<span class="fl">15</span>,<span class="fl">2</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">5</span>,<span class="fl">2</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">time_steps</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">5</span></span>
<span></span>
<span><span class="va">rate1</span> <span class="op">&lt;-</span> <span class="fl">0.25</span></span>
<span><span class="va">api1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_decay.html">variable_decay</a></span><span class="op">(</span><span class="va">pcp</span>, <span class="va">time_steps</span>, <span class="va">rate1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rate2</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">api2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_decay.html">variable_decay</a></span><span class="op">(</span><span class="va">pcp</span>, <span class="va">time_steps</span>, <span class="va">rate2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pcp</span><span class="op">$</span><span class="va">pcp_1</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">22</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">'h'</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">'pcp, api'</span>, xlab <span class="op">=</span> <span class="st">'day'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">api1</span><span class="op">$</span><span class="va">pcp_1</span>, col <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">api2</span><span class="op">$</span><span class="va">pcp_1</span>, col <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="SWATfarmR_files/figure-html/unnamed-chunk-27-1.png" alt="Fig. 8: Two different api time series based on precipitation input and different decay rates" width="700"><p class="caption">
Fig. 8: Two different api time series based on precipitation input and
different decay rates
</p>
</div>
</div>
<div class="section level4">
<h4 id="including-api-into-lrew_demo">Including <code>api</code> into <code>lrew_demo</code><a class="anchor" aria-label="anchor" href="#including-api-into-lrew_demo"></a>
</h4>
<p>We now want to include a new variable <code>api</code> into the
<code>SWATfarmR</code> project <code>lrew_demo</code> which uses the
function <code><a href="../reference/variable_decay.html">variable_decay()</a></code> to account for the antecedent
precipitation. <code>api</code> in each HRU will be based on the
precipitation time series that is linked with an HRU. In this small
example we also want to account for different hydrological soil groups
(HSG) to consider faster (<code>hsg == 'A'</code>) and slower
(<code>hsg == 'D'</code>) soil water retention. Be aware that the
approach below works in such a simple way as we only have one weather
station for the entire demo watershed. In a more complex example with
several weather stations you also must account for the links between
weather stations and HRUs. Thus, this would also require to calculate
all combinations of weather stations and HSGs, which would result in
more than only 4 <code>api</code> variables. In a first step we will
extract the precipitation data and the HSG information for all HRUs from
<code>lrew_demo$.data</code>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load dplyr. We will use functions such as 'mutate' and 'select'.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co"># Extract the precipitation from the farmr project</span></span>
<span><span class="va">pcp</span> <span class="op">&lt;-</span> <span class="va">lrew_demo</span><span class="op">$</span><span class="va">.data</span><span class="op">$</span><span class="va">variables</span><span class="op">$</span><span class="va">pcp</span></span>
<span></span>
<span><span class="co"># Extract the hydrologic soil group values for all HRUs</span></span>
<span><span class="va">hsg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">lrew_demo</span><span class="op">$</span><span class="va">.data</span><span class="op">$</span><span class="va">meta</span><span class="op">$</span><span class="va">hru_attributes</span>, <span class="va">hru</span>, <span class="va">hyd_grp</span><span class="op">)</span></span></code></pre></div>
<p>In a next step we calculate different <code>api</code>s based on the
precipitation data <code>pcp</code>, but using different
<code>decay_rate</code>s for the different HSGs. The values that I set
here for the decay rates are no literature values and were only chosen
for demonstration of the concept here. In an actual study the choice of
values for <code>decay_rate</code> would need some supporting
literature. We combine the variables <code>api_A</code> to
<code>api_D</code> together into one table and assign the names
<code>'api_A'</code> to <code>'api_D'</code> to the columns.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate api values for the hsg classes A to D</span></span>
<span><span class="va">api_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_decay.html">variable_decay</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">pcp</span>, n_steps <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, decay_rate <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">api_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_decay.html">variable_decay</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">pcp</span>, n_steps <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, decay_rate <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">api_C</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_decay.html">variable_decay</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">pcp</span>, n_steps <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, decay_rate <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="va">api_D</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/variable_decay.html">variable_decay</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="va">pcp</span>, n_steps <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, decay_rate <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bind the data together into one api table and name them with the hsgs</span></span>
<span><span class="va">api</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">api_A</span>, <span class="va">api_B</span>, <span class="va">api_C</span>, <span class="va">api_D</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">api</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'api_A'</span>, <span class="st">'api_B'</span>, <span class="st">'api_C'</span>, <span class="st">'api_D'</span><span class="op">)</span></span></code></pre></div>
<p>This is how the final <code>api</code> table looks like.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">api</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9,131 × 4</span></span></span>
<span><span class="co">#&gt;     api_A api_B api_C api_D</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 20.3   20.3  20.3  20.3 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 30.3   32.0  33.0  35.2 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 11.2   14.4  16.4  21.3 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  4.11   6.46  8.13 12.9 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  1.51   2.90  4.04  7.85</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  8.18   8.92  9.62 12.4 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  5.50   6.38  7.01  9.04</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  7.05   7.76  8.22  9.42</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  2.59   3.49  4.08  5.72</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  0.954  1.57  2.03  3.47</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 9,121 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ Use `print(n = ...)` to see more rows</span></span></span></code></pre></div>
<p>We now generated four different time series for <code>api</code>
depending on different retention behaviors based on the HSGs A to D. For
the implementation in the <code>farmr</code> object we have to link the
different <code>api</code> time series to spatial units of the model
setup. Thus, the table to link variables and spatial units must have two
columns, one for the ids of the spatial units and one for the variable
link. We could link e.g. on a routing unit level if we would use
<code>rtu</code> ids, or to HRUs by assigning an <code>api</code> column
to each <code>hru</code> id in the model setup. In this case we link
HRUs and our new variable. The only variable that determines the link of
the <code>api</code> columns with the HRUs is the HSG of an HRU. We
already extracted <code>hsg</code> above and will now link the
<code>hru</code>s with the <code>api</code>s, by creating a table with
the columns <code>hru</code> and <code>api</code>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># To add the variable to the farmR you have to tell it which variables are</span></span>
<span><span class="co"># assigned to which HRUs</span></span>
<span><span class="va">hru_asgn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">hsg</span>, api <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'api_'</span>, <span class="va">hyd_grp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">hru</span>, <span class="va">api</span><span class="op">)</span></span></code></pre></div>
<p>A quick look at the table shows as how the links between HRUs and
<code>api</code> looks like.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hru_asgn</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 49 × 2</span></span></span>
<span><span class="co">#&gt;      hru api  </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 api_B</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2 api_B</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3 api_D</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4 api_C</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5 api_B</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6 api_B</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7 api_D</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8 api_B</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9 api_C</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10 api_B</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 39 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ Use `print(n = ...)` to see more rows</span></span></span></code></pre></div>
<p>We prepared all information that we need to add a new variable. We
can add now the new variable to the <code>farmr</code> object with the
function <code>.$add_variable()</code>. The <code>data</code> we want to
add is the table <code>api</code> that we prepared. The added data must
have the same number of rows as all other variables that are already in
the <code>farmr</code> object. This is ensured in this case as we used
<code>pcp</code> from <code>lrew_demo</code> to calculate
<code>api</code>. We assign the variable <code>name = 'api'</code> to
the new variable in <code>lrew_demo</code>. The name must match the
variable name that is used in the operation conditions of the management
input file and must be different to the names of the already existing
variables. The third input argument <code>assign_unit</code> links the
new variable to the HRUs. Above we defined the links between
<code>hru</code>s and <code>api</code>s in the table
<code>hru_asgn</code> which we will now pass to
<code>.$add_variable</code>.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add the variable api to the farmR project</span></span>
<span><span class="va">lrew_demo</span><span class="op">$</span><span class="fu">add_variable</span><span class="op">(</span>data <span class="op">=</span> <span class="va">api</span>, name <span class="op">=</span> <span class="st">'api'</span>, assign_unit <span class="op">=</span> <span class="va">hru_asgn</span><span class="op">)</span></span></code></pre></div>
<p>We can now check if the new variable <code>api</code> is available in
<code>lrew_demo</code>. <code>api</code> should be available in
<code>lrew_demo$.data$variables$api</code>.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrew_demo</span><span class="op">$</span><span class="va">.data</span><span class="op">$</span><span class="va">variables</span><span class="op">$</span><span class="va">api</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9,131 × 5</span></span></span>
<span><span class="co">#&gt;    date        api_A api_B api_C api_D</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 1988-01-02 20.3   20.3  20.3  20.3 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 1988-01-03 30.3   32.0  33.0  35.2 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 1988-01-04 11.2   14.4  16.4  21.3 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 1988-01-05  4.11   6.46  8.13 12.9 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 1988-01-06  1.51   2.90  4.04  7.85</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 1988-01-07  8.18   8.92  9.62 12.4 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 1988-01-08  5.50   6.38  7.01  9.04</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 1988-01-09  7.05   7.76  8.22  9.42</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 1988-01-10  2.59   3.49  4.08  5.72</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 1988-01-11  0.954  1.57  2.03  3.47</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 9,121 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ Use `print(n = ...)` to see more rows</span></span></span></code></pre></div>
<p>The connections between variables and HRUs are saved in the table
<code>hru_var_connect</code>. We can see that besides the initially
existing variables <code>pcp</code>, <code>tmax</code>,
<code>tmin</code>, and <code>tav</code> which link to the weather
station, there is now a new column that links to the <code>api</code>
columns that we generated.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrew_demo</span><span class="op">$</span><span class="va">.data</span><span class="op">$</span><span class="va">meta</span><span class="op">$</span><span class="va">hru_var_connect</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 49 × 9</span></span></span>
<span><span class="co">#&gt;      rtu rtu_name   hru hru_name pcp    tmax     tmin     tav      api  </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 rtu10        1 hru01    pcp144 lrew_tmp lrew_tmp lrew_tmp api_B</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1 rtu10        2 hru02    pcp144 lrew_tmp lrew_tmp lrew_tmp api_B</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1 rtu10        3 hru03    pcp144 lrew_tmp lrew_tmp lrew_tmp api_D</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1 rtu10        4 hru04    pcp144 lrew_tmp lrew_tmp lrew_tmp api_C</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1 rtu10        5 hru05    pcp144 lrew_tmp lrew_tmp lrew_tmp api_B</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1 rtu10        6 hru06    pcp144 lrew_tmp lrew_tmp lrew_tmp api_B</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1 rtu10        7 hru07    pcp144 lrew_tmp lrew_tmp lrew_tmp api_D</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1 rtu10        8 hru08    pcp144 lrew_tmp lrew_tmp lrew_tmp api_B</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1 rtu10        9 hru09    pcp144 lrew_tmp lrew_tmp lrew_tmp api_C</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     1 rtu10       10 hru10    pcp144 lrew_tmp lrew_tmp lrew_tmp api_B</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 39 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ Use `print(n = ...)` to see more rows</span></span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="scheduling-operations">Scheduling operations<a class="anchor" aria-label="anchor" href="#scheduling-operations"></a>
</h3>
<p><code>lrew_demo</code> now contains a management input file and all
the required variables that are used in the scheduling conditions. So we
can start scheduling management operations. We can again use the
function <code>.$schedule_operations()</code> that was unlocked after
reading the management input file. <code>.$schedule_operations()</code>
has three input arguments.</p>
<p>The first two input arguments are <code>start_year</code> and
<code>end_year</code>. By default <code>.$schedule_operations()</code>
would schedule farm management operations for the entire time period
that is available from the variable time series. Above you can see that
the <code>date</code> of <code>api</code> starts in 1988 (and ends in
2012). This is the available time period of the weather data that was
used in the model setup process. Scheduling farm management operations
can be quite time intensive and may run several hours for larger model
setups. Thus I recommend to constrain the time window for the operation
scheduling to a shorter time period if any time period outside of the
defined time window would never be used in simulations. Be aware that if
you want to use a time period that is not covered by
<code>start_year</code> and <code>end_year</code> would require to
repeat the scheduling.</p>
<p>The third input argument is <code>n_schedule</code> which is useful
to speed up the scheduling process a bit by reducing the number of
different schedules. <code>n_schedule</code> controls how many different
schedules per land use and routing unit will be generated. Default a
unique operation schedule will be generated for each HRU. If
e.g. <code>n_schedule = 1</code> a schedule will be generated for a
certain land use in a routing unit and all other land uses within the
same routing unit would use the same schedule. Our small demo watershed
for example only consists of one routing unit with 49 HRUs. 3 HRUs use
the land use <em>‘lrew_ag1’</em>. In this case only 1 schedule would be
generated if <code>n_schedule = 1</code> and the other two HRUs would
use the same schedule (which saves computation time as the scheduling
process would simply be skipped for those 2 HRUs). If e.g
<code>n_schedule = 2</code> the first 2 HRUs would get different
schedules and the third HRU would select one of the two existing
schedules randomly.</p>
<p>In our simple example we want to generate operation schedules for the
time window 2000 to 2008. We will only generate two individual schedules
per land use.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrew_demo</span><span class="op">$</span><span class="fu">schedule_operations</span><span class="op">(</span>start_year <span class="op">=</span> <span class="fl">2000</span>, end_year <span class="op">=</span> <span class="fl">2008</span>, n_schedule <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; Scheduling operations:</span></span>
<span><span class="co">#&gt;  HRU 1 of 49   Time elapsed: 0S   Time remaining: 48S</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt; Scheduling operations:</span></span>
<span><span class="co">#&gt;  Finished scheduling 49 HRUs in 11S </span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="writing-operations">Writing operations<a class="anchor" aria-label="anchor" href="#writing-operations"></a>
</h3>
<p>When the scheduling was successful we can write the scheduled
operations into the SWAT project using the function
<code>.$write_operations()</code>. <code>.$write_operations()</code>
again uses the two optional input arguments <code>start_year</code> and
<code>end_year</code>. Within the scheduled time window we can select a
shorter time window to write the operations for. This is for example an
interesting option if you want to only write the operations for the
calibration time period, run the simulations to calibrate the model and
then rewrite the management for the validation period. If
<code>start_year</code> and <code>end_year</code> are not used the
entire time period that was scheduled will be written into the
management files. For the demo project we will write the management in
the time window 2000 to 2005.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrew_demo</span><span class="op">$</span><span class="fu">write_operations</span><span class="op">(</span>start_year <span class="op">=</span> <span class="fl">2000</span>, end_year <span class="op">=</span> <span class="fl">2005</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; Writing management files:</span></span>
<span><span class="co">#&gt;   - Writing 'hru-data.hru'</span></span>
<span><span class="co">#&gt;   - Writing 'landuse.lum' and 'schedule.mgt'</span></span>
<span><span class="co">#&gt;   - Writing 'time.sim'</span></span>
<span><span class="co">#&gt; Finished writing management schedules in 1S</span></span></code></pre></div>
<p>From the output message you can see that for a SWAT+ setup the files
<em>‘hru-data.hru’</em>, <em>‘landuse.lum’</em>,
<em>‘schedule.mgt’</em>, and <em>‘time.sim’</em> are overwritten. In
<em>‘landuse.lum’</em> you can see that copies of the initial
agricultural land uses were made and a suffix
<code>&lt;rout_unit&gt;_&lt;i_schedule&gt;</code> with two values was
added to differentiate between the individual scheduled managements. The
last suffix is either 1 or 2 as we limited the number of individual
schedules per land use to 2.</p>
<div class="figure">
<img src="figures/landuse_lum.JPG" alt=""><p class="caption">Fig. 9: Screenshot of the rewritten ‘landuse.lum’
file in the SWAT+ project.</p>
</div>
<p>The HRUs in the <em>‘hru-data.hru’</em> now point to the new land
uses in <em>‘landuse.lum’</em>.</p>
<div class="figure">
<img src="figures/hru_data.JPG" alt=""><p class="caption">Fig. 10: Screenshot of the rewritten ‘hru-data.hru’
file in the SWAT+ project.</p>
</div>
<p>Fig. 11 shows a screenshot of the written operation schedule for
<code>agrl1_mgt_1_1</code> in <em>‘schedule.mgt’</em>. You can see that
operations for 6 years (2000 to 2005) were written. The scheduled
operation dates are now selected based on the conditions in the
management input file and the time series of the weather variables and
the additional variable <code>api</code>. I therefore want to stress
that the scheduled operation dates are always linked to the simulation
period, which is controlled by the input file <em>‘time.sim’</em>. Thus,
<em>‘time.sim’</em> is always written together with the management
schedule. By manually changing the simulation period in
<em>‘time.sim’</em> we would loose this link between scheduling
conditions and the time series of the variables.</p>
<div class="figure">
<img src="figures/management.JPG" alt=""><p class="caption">Fig. 11: Screenshot of the rewritten ‘schedule.mgt’
file in the SWAT+ project.</p>
</div>
</div>
<div class="section level3">
<h3 id="resetting-the-swat-project">Resetting the SWAT project<a class="anchor" aria-label="anchor" href="#resetting-the-swat-project"></a>
</h3>
<p>Writing the management schedules overwrites the original SWAT project
input files. The <code>farmr</code> project however made a copy of the
initial input files which will be overwritten. With
<code>.$reset_files()</code> you can reset the project to its initial
version.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrew_demo</span><span class="op">$</span><span class="fu">reset_files</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body">
<div id="ref-Bosch2007" class="csl-entry">
Bosch, D. D., Sheridan, J. M., Lowrance, R. R., Hubbard, R. K.,
Strickland, T. C., Feyereisen, G. W. and Sullivan, D. G.: Little river
experimental watershed database, Water Resources Research, 43(9), doi:<a href="https://doi.org/10.1029/2006wr005844" class="external-link">10.1029/2006wr005844</a>,
2007.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/chrisschuerz" class="external-link">Christoph Schuerz</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
